# Copyright 2024-2025 David Gordon Nix
# SPDX-License-Identifier: Apache-2.0

"""
Example Scripts End-to-End Tests

This module executes all example scripts as end-to-end tests to catch regressions
that unit tests miss (e.g., IRR calculation failures, integration issues).

These tests validate that our public examples continue to work as expected,
ensuring that architectural changes don't break real-world usage patterns.
"""

import sys
from pathlib import Path

# Add examples directory to path for imports
examples_dir = Path(__file__).parent.parent.parent / "examples"
sys.path.insert(0, str(examples_dir))


class TestExampleScripts:
    """Test that all example scripts execute without errors and produce exact expected values."""

    def test_basic_office_development(self):
        """Test basic office development example executes and produces expected results."""
        # Import and capture results instead of just calling main()
        from datetime import date

        from performa.patterns import OfficeDevelopmentPattern
        
        # Create exact pattern from basic example
        pattern = OfficeDevelopmentPattern(
            project_name="Metro Office Tower Development",
            acquisition_date=date(2024, 1, 1),
            land_cost=2_000_000,
            building_sf=50_000,
            floors=3,
            net_rentable_area=45_000,
            target_rent_psf=35.0,
            construction_ltc_ratio=0.65,
        )
        
        results = pattern.analyze()
        
        # Validate exact results (prevent regressions)
        assert abs(results.deal_metrics.irr - (-0.335)) < 0.01, f"IRR changed: {results.deal_metrics.irr:.3f}"
        assert abs(results.deal_metrics.equity_multiple - 0.15) < 0.01, f"EM changed: {results.deal_metrics.equity_multiple:.2f}"

    def test_stabilized_multifamily_acquisition(self):
        """Test stabilized acquisition example executes successfully."""
        import stabilized_multifamily_acquisition  # noqa  # type:ignore
        
        stabilized_multifamily_acquisition.main()

    def test_value_add_renovation(self):
        """Test value-add renovation example executes successfully."""
        import value_add_renovation  # noqa  # type:ignore
        
        value_add_renovation.main()

    def test_office_stabilized_acquisition_comparison(self):
        """Test office stabilized acquisition comparison example."""
        import office_stabilized_acquisition_comparison  # noqa  # type:ignore
        
        office_stabilized_acquisition_comparison.main()


class TestPatternExamples:
    """Test that pattern-based examples execute without errors."""
    
    def test_office_development_comparison(self):
        """Test office development pattern comparison."""
        patterns_dir = examples_dir / "patterns"
        sys.path.insert(0, str(patterns_dir))
        
        import office_development_comparison  # noqa  # type:ignore
        office_development_comparison.main()

    def test_residential_development_comparison(self):
        """Test residential development pattern comparison with exact value validation."""
        from datetime import date

        from performa.patterns import ResidentialDevelopmentPattern
        
        # Create exact pattern from working script
        pattern = ResidentialDevelopmentPattern(
            project_name="Institutional Residential Development",
            acquisition_date=date(2024, 1, 1),
            land_cost=8_000_000,
            total_units=120,
            unit_mix=[
                {'unit_type': 'Studio', 'count': 24, 'avg_sf': 500, 'target_rent': 1200},
                {'unit_type': '1BR', 'count': 48, 'avg_sf': 650, 'target_rent': 1500},
                {'unit_type': '2BR', 'count': 36, 'avg_sf': 900, 'target_rent': 2000},
                {'unit_type': '3BR', 'count': 12, 'avg_sf': 1100, 'target_rent': 2400}
            ],
            construction_cost_per_unit=160_000,
            construction_start_months=1,
            construction_duration_months=18,
            soft_costs_rate=0.08,
            developer_fee_rate=0.05,
            absorption_pace_units_per_month=8,
            construction_ltc_ratio=0.70,
            construction_interest_rate=0.065,
            permanent_ltv_ratio=0.70,  # Fixed from 0.75 to pass DSCR
            permanent_interest_rate=0.055,
            permanent_loan_term_years=10,
            permanent_amortization_years=30,
            distribution_method="waterfall",
            gp_share=0.10,
            preferred_return=0.08,
            promote_tier_1=0.15,
            hold_period_years=5,
            exit_cap_rate=0.055
        )
        
        results = pattern.analyze()
        
        # EXACT VALUE VALIDATION (prevent any regressions)
        assert abs(pattern.total_project_cost - 28_736_000) < 1000, f"Project cost changed: {pattern.total_project_cost:,.0f}"
        assert abs(results.deal_metrics.irr - 0.1818) < 0.005, f"IRR changed: {results.deal_metrics.irr:.4f}"
        assert abs(results.deal_metrics.equity_multiple - 2.24) < 0.05, f"EM changed: {results.deal_metrics.equity_multiple:.2f}"
        
        # Validate partner distributions
        from performa.reporting.debug import dump_performa_object
        pd_dump = dump_performa_object(results.partner_distributions, exclude_defaults=False)['config']
        total_investment = pd_dump.get('total_investment', 0)
        total_distributions = pd_dump.get('total_distributions', 0)
        
        assert abs(total_investment - 18_086_664) < 100_000, f"Investment changed: {total_investment:,.0f}"
        assert abs(total_distributions - 40_511_908) < 500_000, f"Distributions changed: {total_distributions:,.0f}"

    def test_stabilized_comparison(self):
        """Test stabilized acquisition pattern comparison."""
        patterns_dir = examples_dir / "patterns"
        sys.path.insert(0, str(patterns_dir))
        
        import stabilized_comparison  # noqa  # type:ignore
        stabilized_comparison.main()

    def test_value_add_comparison(self):
        """Test value-add acquisition pattern comparison."""
        patterns_dir = examples_dir / "patterns"
        sys.path.insert(0, str(patterns_dir))
        
        import value_add_comparison
        value_add_comparison.main()


class TestLeverageAndValidation:
    """Test critical leverage mechanics and validation guard rails with exact values."""
    
    def test_leverage_effect_exact_values(self):
        """Test leverage effect with exact value validation to prevent regressions."""
        from datetime import date

        from performa.patterns import ResidentialDevelopmentPattern
        
        base_params = {
            'project_name': 'Leverage Test',
            'acquisition_date': date(2024, 1, 1),
            'land_cost': 8_000_000,
            'total_units': 120,
            'unit_mix': [
                {'unit_type': 'Studio', 'count': 24, 'avg_sf': 500, 'target_rent': 1200},
                {'unit_type': '1BR', 'count': 48, 'avg_sf': 650, 'target_rent': 1500},
                {'unit_type': '2BR', 'count': 36, 'avg_sf': 900, 'target_rent': 2000},
                {'unit_type': '3BR', 'count': 12, 'avg_sf': 1100, 'target_rent': 2400}
            ],
            'construction_cost_per_unit': 160_000,
            'exit_cap_rate': 0.055,
        }
        
        # Test 50% debt leverage
        pattern_50 = ResidentialDevelopmentPattern(
            **base_params,
            construction_ltc_ratio=0.50,
            permanent_ltv_ratio=0.70,
        )
        results_50 = pattern_50.analyze()
        
        # Test 70% debt leverage  
        pattern_70 = ResidentialDevelopmentPattern(
            **base_params,
            construction_ltc_ratio=0.70,
            permanent_ltv_ratio=0.70,
        )
        results_70 = pattern_70.analyze()
        
        # EXACT VALUE VALIDATION (must not change)
        assert abs(results_50.deal_metrics.irr - 0.0390) < 0.001, f"50% debt IRR changed: {results_50.deal_metrics.irr:.4f}"
        assert abs(results_50.deal_metrics.equity_multiple - 1.297) < 0.01, f"50% debt EM changed: {results_50.deal_metrics.equity_multiple:.3f}"
        
        assert abs(results_70.deal_metrics.irr - 0.1172) < 0.001, f"70% debt IRR changed: {results_70.deal_metrics.irr:.4f}"
        assert abs(results_70.deal_metrics.equity_multiple - 2.122) < 0.01, f"70% debt EM changed: {results_70.deal_metrics.equity_multiple:.3f}"
        
        # LEVERAGE EFFECT VALIDATION (critical architectural requirement)
        assert results_70.deal_metrics.irr > results_50.deal_metrics.irr, "CRITICAL: Leverage effect broken - higher debt should mean higher IRR"
        assert results_70.deal_metrics.equity_multiple > results_50.deal_metrics.equity_multiple, "CRITICAL: Leverage effect broken - higher debt should mean higher EM"

    def test_dscr_validation_prevents_bad_deals(self):
        """Test that DSCR validation prevents covenant violations."""
        from datetime import date

        import pytest

        from performa.patterns import ResidentialDevelopmentPattern
        
        # This should fail DSCR validation (verified to fail at 0.75 LTV)
        with pytest.raises(ValueError, match="DSCR VIOLATION"):
            ResidentialDevelopmentPattern(
                project_name="Bad DSCR Test", 
                acquisition_date=date(2024, 1, 1),
                land_cost=8_000_000,
                total_units=120,
                unit_mix=[
                    {'unit_type': 'Studio', 'count': 24, 'avg_sf': 500, 'target_rent': 1200},
                    {'unit_type': '1BR', 'count': 48, 'avg_sf': 650, 'target_rent': 1500},
                    {'unit_type': '2BR', 'count': 36, 'avg_sf': 900, 'target_rent': 2000},
                    {'unit_type': '3BR', 'count': 12, 'avg_sf': 1100, 'target_rent': 2400}
                ],
                construction_cost_per_unit=160_000,
                construction_ltc_ratio=0.70,
                permanent_ltv_ratio=0.75,  # Too high - fails DSCR (verified)
                exit_cap_rate=0.055,
            )

    def test_value_destruction_guard_rails(self):
        """Test that value-destructive deals are prevented."""
        from datetime import date

        import pytest

        from performa.patterns import ResidentialDevelopmentPattern
        
        # This should fail value creation validation (verified to fail)
        with pytest.raises(ValueError, match="DEAL INFEASIBLE"):
            ResidentialDevelopmentPattern(
                project_name="Value Destroyer",
                acquisition_date=date(2024, 1, 1),
                land_cost=20_000_000,  # Very expensive land
                construction_ltc_ratio=0.70,
                total_units=50,
                unit_mix=[{'unit_type': '1BR', 'count': 50, 'avg_sf': 650, 'target_rent': 400}],  # Very low rent
                exit_cap_rate=0.10,  # High cap rate = low value
            )

    def test_refinancing_infeasible_guard_rails(self):
        """Test that refinancing infeasible deals are prevented."""
        from datetime import date

        import pytest

        from performa.patterns import ResidentialDevelopmentPattern
        
        # This should fail refinancing feasibility (verified to fail)
        with pytest.raises(ValueError, match="REFINANCING INFEASIBLE"):
            ResidentialDevelopmentPattern(
                project_name="No Cash-Out",
                acquisition_date=date(2024, 1, 1),
                land_cost=8_000_000,
                construction_ltc_ratio=0.85,  # Very high construction debt
                permanent_ltv_ratio=0.65,     # Low permanent LTV
                total_units=120,
                unit_mix=[
                    {'unit_type': 'Studio', 'count': 24, 'avg_sf': 500, 'target_rent': 1200},
                    {'unit_type': '1BR', 'count': 48, 'avg_sf': 650, 'target_rent': 1500},
                    {'unit_type': '2BR', 'count': 36, 'avg_sf': 900, 'target_rent': 2000},
                    {'unit_type': '3BR', 'count': 12, 'avg_sf': 1100, 'target_rent': 2400}
                ],
                construction_cost_per_unit=160_000,
                exit_cap_rate=0.055,
            )
